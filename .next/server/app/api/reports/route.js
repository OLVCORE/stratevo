"use strict";(()=>{var e={};e.id=867,e.ids=[867],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},9537:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>h,patchFetch:()=>S,requestAsyncStorage:()=>g,routeModule:()=>y,serverHooks:()=>v,staticGenerationAsyncStorage:()=>x});var s={};r.r(s),r.d(s,{GET:()=>w,POST:()=>m});var a=r(49303),n=r(88716),i=r(60670),o=r(87070),u=r(75571),l=r(47944),d=r(75748),p=r(8473),c=r(36713);async function m(e){try{let t=await (0,u.getServerSession)(l.L);if(!t?.user?.email)return o.NextResponse.json({message:"N\xe3o autorizado"},{status:401});let{cnpj:r,website:s}=await e.json();if(!r)return o.NextResponse.json({message:"CNPJ \xe9 obrigat\xf3rio"},{status:400});await (0,d.u)();let a=await c.Z.findOne({email:t.user.email});if(!a)return o.NextResponse.json({message:"Usu\xe1rio n\xe3o encontrado"},{status:404});if(-1!==a.reportsLimit&&a.reportsCount>=a.reportsLimit)return o.NextResponse.json({message:"Limite de relat\xf3rios atingido. Fa\xe7a upgrade do seu plano."},{status:403});let n=new p.Z({userId:a._id,companyName:"Empresa a ser analisada",cnpj:r,website:s,status:"processing"});return await n.save(),a.reportsCount+=1,await a.save(),f(n._id,r,s),o.NextResponse.json({message:"Relat\xf3rio iniciado",reportId:n._id,status:"processing"},{status:201})}catch(e){return console.error("Create report error:",e),o.NextResponse.json({message:"Erro interno do servidor"},{status:500})}}async function w(e){try{let e=await (0,u.getServerSession)(l.L);if(!e?.user?.email)return o.NextResponse.json({message:"N\xe3o autorizado"},{status:401});await (0,d.u)();let t=await c.Z.findOne({email:e.user.email});if(!t)return o.NextResponse.json({message:"Usu\xe1rio n\xe3o encontrado"},{status:404});let r=await p.Z.find({userId:t._id}).sort({createdAt:-1}).limit(20);return o.NextResponse.json({reports:r})}catch(e){return console.error("Get reports error:",e),o.NextResponse.json({message:"Erro interno do servidor"},{status:500})}}async function f(e,t,r){try{await new Promise(e=>setTimeout(e,5e3)),await (0,d.u)();let r=await p.Z.findById(e);r&&(r.status="completed",r.data={cadastral:{cnpj:t,status:"Processado"},financial:{status:"Processado"},digital:{status:"Processado"},commercial:{status:"Processado"},supplyChain:{status:"Processado"},news:{status:"Processado"},swot:{status:"Processado"}},await r.save())}catch(r){console.error("Process report error:",r),await (0,d.u)();let t=await p.Z.findById(e);t&&(t.status="failed",await t.save())}}let y=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/reports/route",pathname:"/api/reports",filename:"route",bundlePath:"app/api/reports/route"},resolvedPagePath:"C:\\Projects\\01 - Stratevo\\src\\app\\api\\reports\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:g,staticGenerationAsyncStorage:x,serverHooks:v}=y,h="/api/reports/route";function S(){return(0,i.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:x})}},41017:(e,t,r)=>{t.dJ=t.WU=t.c_=void 0;let s=r(38013);function a(e){return(null==e?void 0:e.length)!==24?new s.ObjectId:new s.ObjectId(e)}t.c_={Users:"users",Accounts:"accounts",Sessions:"sessions",VerificationTokens:"verification_tokens"},t.WU={from(e){let t={};for(let r in e){let s=e[r];"_id"===r?t.id=s.toHexString():"userId"===r?t[r]=s.toHexString():t[r]=s}return t},to(e){let t={_id:a(e.id)};for(let r in e){let s=e[r];if("userId"===r)t[r]=a(s);else{if("id"===r)continue;t[r]=s}}return t}},t.dJ=function(e,r={}){let{collections:n}=r,{from:i,to:o}=t.WU,u=(async()=>{let s=(await e).db(r.databaseName),a={...t.c_,...n};return{U:s.collection(a.Users),A:s.collection(a.Accounts),S:s.collection(a.Sessions),V:s.collection(null==a?void 0:a.VerificationTokens)}})();return{async createUser(e){let t=o(e);return await (await u).U.insertOne(t),i(t)},async getUser(e){let t=await (await u).U.findOne({_id:a(e)});return t?i(t):null},async getUserByEmail(e){let t=await (await u).U.findOne({email:e});return t?i(t):null},async getUserByAccount(e){let t=await (await u).A.findOne(e);if(!t)return null;let r=await (await u).U.findOne({_id:new s.ObjectId(t.userId)});return r?i(r):null},async updateUser(e){let{_id:t,...r}=o(e);return i((await (await u).U.findOneAndUpdate({_id:t},{$set:r},{returnDocument:"after"})).value)},async deleteUser(e){let t=a(e),r=await u;await Promise.all([r.A.deleteMany({userId:t}),r.S.deleteMany({userId:t}),r.U.deleteOne({_id:t})])},linkAccount:async e=>{let t=o(e);return await (await u).A.insertOne(t),t},async unlinkAccount(e){let{value:t}=await (await u).A.findOneAndDelete(e);return i(t)},async getSessionAndUser(e){let t=await (await u).S.findOne({sessionToken:e});if(!t)return null;let r=await (await u).U.findOne({_id:new s.ObjectId(t.userId)});return r?{user:i(r),session:i(t)}:null},async createSession(e){let t=o(e);return await (await u).S.insertOne(t),i(t)},async updateSession(e){let{_id:t,...r}=o(e);return i((await (await u).S.findOneAndUpdate({sessionToken:r.sessionToken},{$set:r},{returnDocument:"after"})).value)},async deleteSession(e){let{value:t}=await (await u).S.findOneAndDelete({sessionToken:e});return i(t)},createVerificationToken:async e=>(await (await u).V.insertOne(o(e)),e),async useVerificationToken(e){let{value:t}=await (await u).V.findOneAndDelete(e);return t?(delete t._id,t):null}}}},47944:(e,t,r)=>{let s;r.d(t,{L:()=>c});var a=r(77234),n=r(53797),i=r(41017),o=r(38013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let u=process.env.MONGODB_URI;s=new o.MongoClient(u,{}).connect();var l=r(42023),d=r(75748),p=r(36713);let c={adapter:(0,i.dJ)(s),providers:[(0,a.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,n.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;await (0,d.u)();let t=await p.Z.findOne({email:e.email});return t&&t.password&&await (0,l.compare)(e.password,t.password)?{id:t._id.toString(),email:t.email,name:t.name,plan:t.plan}:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.plan=t.plan),e),session:async({session:e,token:t})=>(t&&(e.user.plan=t.plan),e)},pages:{signIn:"/auth/signin",signUp:"/auth/signup"}}},75748:(e,t,r)=>{r.d(t,{u:()=>o});var s=r(11185),a=r.n(s);let n=process.env.MONGODB_URI;if(!n)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let i=global.mongoose;async function o(){if(i.conn)return i.conn;i.promise||(i.promise=a().connect(n,{bufferCommands:!1}).then(e=>e));try{i.conn=await i.promise}catch(e){throw i.promise=null,e}return i.conn}i||(i=global.mongoose={conn:null,promise:null})},8473:(e,t,r)=>{r.d(t,{Z:()=>i});var s=r(11185),a=r.n(s);let n=new(a()).Schema({userId:{type:a().Schema.Types.ObjectId,ref:"User",required:!0},companyName:{type:String,required:!0},cnpj:{type:String,required:!0},website:{type:String},data:{cadastral:{type:a().Schema.Types.Mixed,default:{}},financial:{type:a().Schema.Types.Mixed,default:{}},digital:{type:a().Schema.Types.Mixed,default:{}},commercial:{type:a().Schema.Types.Mixed,default:{}},supplyChain:{type:a().Schema.Types.Mixed,default:{}},news:{type:a().Schema.Types.Mixed,default:{}},swot:{type:a().Schema.Types.Mixed,default:{}}},status:{type:String,enum:["processing","completed","failed"],default:"processing"}},{timestamps:!0}),i=a().models.Report||a().model("Report",n)},36713:(e,t,r)=>{r.d(t,{Z:()=>o});var s=r(11185),a=r.n(s),n=r(42023);let i=new(a()).Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},password:{type:String},plan:{type:String,enum:["freemium","standard","premium","pro","platinum"],default:"freemium"},reportsCount:{type:Number,default:0},reportsLimit:{type:Number,default:5}},{timestamps:!0});i.pre("save",async function(e){this.isModified("password")&&this.password&&(this.password=await (0,n.hash)(this.password,12)),e()}),i.pre("save",function(e){this.reportsLimit=({freemium:5,standard:50,premium:200,pro:500,platinum:-1})[this.plan],e()});let o=a().models.User||a().model("User",i)}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,23,734],()=>r(9537));module.exports=s})();