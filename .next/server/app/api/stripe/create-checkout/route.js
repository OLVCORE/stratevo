"use strict";(()=>{var e={};e.id=92,e.ids=[92],e.modules={38013:e=>{e.exports=require("mongodb")},11185:e=>{e.exports=require("mongoose")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},56173:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>O,requestAsyncStorage:()=>f,routeModule:()=>w,serverHooks:()=>y,staticGenerationAsyncStorage:()=>g});var s={};r.r(s),r.d(s,{POST:()=>m});var n=r(49303),i=r(88716),a=r(60670),o=r(87070),u=r(75571),l=r(47944),c=r(46029),p=r(75748),d=r(36713);async function m(e){try{let t=await (0,u.getServerSession)(l.L);if(!t?.user?.email)return o.NextResponse.json({message:"N\xe3o autorizado"},{status:401});let{plan:r}=await e.json();if(!c.z[r])return o.NextResponse.json({message:"Plano inv\xe1lido"},{status:400});await (0,p.u)();let s=await d.Z.findOne({email:t.user.email});if(!s)return o.NextResponse.json({message:"Usu\xe1rio n\xe3o encontrado"},{status:404});let n=c.z[r];if(0===n.price)return s.plan=r,s.reportsLimit=n.reportsLimit,await s.save(),o.NextResponse.json({message:"Plano atualizado com sucesso",plan:r});if(!("stripePriceId"in n))return o.NextResponse.json({message:"Plano sem stripePriceId configurado"},{status:400});let i=await c.A.checkout.sessions.create({payment_method_types:["card"],line_items:[{price:n.stripePriceId,quantity:1}],mode:"subscription",success_url:`${process.env.NEXTAUTH_URL}/dashboard?success=true&plan=${r}`,cancel_url:`${process.env.NEXTAUTH_URL}/pricing?canceled=true`,customer_email:s.email,metadata:{userId:s._id.toString(),plan:r}});return o.NextResponse.json({sessionId:i.id})}catch(e){return console.error("Erro ao criar checkout:",e),o.NextResponse.json({message:"Erro interno do servidor"},{status:500})}}let w=new n.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/stripe/create-checkout/route",pathname:"/api/stripe/create-checkout",filename:"route",bundlePath:"app/api/stripe/create-checkout/route"},resolvedPagePath:"C:\\Projects\\01 - Stratevo\\src\\app\\api\\stripe\\create-checkout\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:f,staticGenerationAsyncStorage:g,serverHooks:y}=w,v="/api/stripe/create-checkout/route";function O(){return(0,a.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:g})}},41017:(e,t,r)=>{t.dJ=t.WU=t.c_=void 0;let s=r(38013);function n(e){return(null==e?void 0:e.length)!==24?new s.ObjectId:new s.ObjectId(e)}t.c_={Users:"users",Accounts:"accounts",Sessions:"sessions",VerificationTokens:"verification_tokens"},t.WU={from(e){let t={};for(let r in e){let s=e[r];"_id"===r?t.id=s.toHexString():"userId"===r?t[r]=s.toHexString():t[r]=s}return t},to(e){let t={_id:n(e.id)};for(let r in e){let s=e[r];if("userId"===r)t[r]=n(s);else{if("id"===r)continue;t[r]=s}}return t}},t.dJ=function(e,r={}){let{collections:i}=r,{from:a,to:o}=t.WU,u=(async()=>{let s=(await e).db(r.databaseName),n={...t.c_,...i};return{U:s.collection(n.Users),A:s.collection(n.Accounts),S:s.collection(n.Sessions),V:s.collection(null==n?void 0:n.VerificationTokens)}})();return{async createUser(e){let t=o(e);return await (await u).U.insertOne(t),a(t)},async getUser(e){let t=await (await u).U.findOne({_id:n(e)});return t?a(t):null},async getUserByEmail(e){let t=await (await u).U.findOne({email:e});return t?a(t):null},async getUserByAccount(e){let t=await (await u).A.findOne(e);if(!t)return null;let r=await (await u).U.findOne({_id:new s.ObjectId(t.userId)});return r?a(r):null},async updateUser(e){let{_id:t,...r}=o(e);return a((await (await u).U.findOneAndUpdate({_id:t},{$set:r},{returnDocument:"after"})).value)},async deleteUser(e){let t=n(e),r=await u;await Promise.all([r.A.deleteMany({userId:t}),r.S.deleteMany({userId:t}),r.U.deleteOne({_id:t})])},linkAccount:async e=>{let t=o(e);return await (await u).A.insertOne(t),t},async unlinkAccount(e){let{value:t}=await (await u).A.findOneAndDelete(e);return a(t)},async getSessionAndUser(e){let t=await (await u).S.findOne({sessionToken:e});if(!t)return null;let r=await (await u).U.findOne({_id:new s.ObjectId(t.userId)});return r?{user:a(r),session:a(t)}:null},async createSession(e){let t=o(e);return await (await u).S.insertOne(t),a(t)},async updateSession(e){let{_id:t,...r}=o(e);return a((await (await u).S.findOneAndUpdate({sessionToken:r.sessionToken},{$set:r},{returnDocument:"after"})).value)},async deleteSession(e){let{value:t}=await (await u).S.findOneAndDelete({sessionToken:e});return a(t)},createVerificationToken:async e=>(await (await u).V.insertOne(o(e)),e),async useVerificationToken(e){let{value:t}=await (await u).V.findOneAndDelete(e);return t?(delete t._id,t):null}}}},47944:(e,t,r)=>{let s;r.d(t,{L:()=>d});var n=r(77234),i=r(53797),a=r(41017),o=r(38013);if(!process.env.MONGODB_URI)throw Error('Invalid/Missing environment variable: "MONGODB_URI"');let u=process.env.MONGODB_URI;s=new o.MongoClient(u,{}).connect();var l=r(42023),c=r(75748),p=r(36713);let d={adapter:(0,a.dJ)(s),providers:[(0,n.Z)({clientId:process.env.GOOGLE_CLIENT_ID,clientSecret:process.env.GOOGLE_CLIENT_SECRET}),(0,i.Z)({name:"credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;await (0,c.u)();let t=await p.Z.findOne({email:e.email});return t&&t.password&&await (0,l.compare)(e.password,t.password)?t:null}})],session:{strategy:"jwt"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.plan=t.plan),e),session:async({session:e,token:t})=>(t&&(e.user.plan=t.plan),e)},pages:{signIn:"/auth/signin",signUp:"/auth/signup"}}},75748:(e,t,r)=>{r.d(t,{u:()=>o});var s=r(11185),n=r.n(s);let i=process.env.MONGODB_URI;if(!i)throw Error("Please define the MONGODB_URI environment variable inside .env.local");let a=global.mongoose;async function o(){if(a.conn)return a.conn;a.promise||(a.promise=n().connect(i,{bufferCommands:!1}).then(e=>e));try{a.conn=await a.promise}catch(e){throw a.promise=null,e}return a.conn}a||(a=global.mongoose={conn:null,promise:null})},36713:(e,t,r)=>{r.d(t,{Z:()=>o});var s=r(11185),n=r.n(s),i=r(42023);let a=new(n()).Schema({name:{type:String,required:!0},email:{type:String,required:!0,unique:!0},password:{type:String},plan:{type:String,enum:["freemium","standard","premium","pro","platinum"],default:"freemium"},reportsCount:{type:Number,default:0},reportsLimit:{type:Number,default:5}},{timestamps:!0});a.pre("save",async function(e){this.isModified("password")&&this.password&&(this.password=await (0,i.hash)(this.password,12)),e()}),a.pre("save",function(e){this.reportsLimit=({freemium:5,standard:50,premium:200,pro:500,platinum:-1})[this.plan],e()});let o=n().models.User||n().model("User",a)},46029:(e,t,r)=>{r.d(t,{A:()=>s,z:()=>n});let s=new(r(41481)).Z(process.env.STRIPE_SECRET_KEY||"sk_test_PLACEHOLDER",{apiVersion:"2023-10-16"}),n={free:{name:"Freemium",price:0,reportsLimit:5,features:["Acesso b\xe1sico","5 relat\xf3rios/m\xeas"]},standard:{name:"Standard",price:97,stripePriceId:"price_PLACEHOLDER_STANDARD",reportsLimit:50,features:["Acesso completo","50 relat\xf3rios/m\xeas"]},premium:{name:"Premium",price:197,stripePriceId:"price_PLACEHOLDER_PREMIUM",reportsLimit:200,features:["Acesso premium","200 relat\xf3rios/m\xeas"]},pro:{name:"Pro",price:497,stripePriceId:"price_PLACEHOLDER_PRO",reportsLimit:500,features:["Acesso PRO","500 relat\xf3rios/m\xeas"]},platinum:{name:"Platinum",price:99700,stripePriceId:"price_platinum_monthly",reportsLimit:-1,features:["Relat\xf3rios ilimitados","Todas as features Pro","Consultoria dedicada","Integra\xe7\xe3o customizada"]}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,972,23,734,481],()=>r(56173));module.exports=s})();